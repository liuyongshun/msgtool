name: ğŸ“° Sync RSS Feeds

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´6ç‚¹ã€12ç‚¹ã€18ç‚¹ (UTC-2, 4, 10)
    - cron: '0 22 * * *'  # 06:00 åŒ—äº¬æ—¶é—´
    - cron: '0 4 * * *'   # 12:00 åŒ—äº¬æ—¶é—´
    - cron: '0 10 * * *'  # 18:00 åŒ—äº¬æ—¶é—´
  
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  sync-rss:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout repository
      uses: actions/checkout@v4
    
    - name: ğŸ Set up Python 3.9
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
        cache: 'pip'
    
    - name: ğŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: âš™ï¸ Create logs directory
      run: |
        mkdir -p logs output/validation
    - name: ğŸ” Validate RSS sources
      id: validate
      run: |
        python test/validate_sources.py > output/rss_validation_$(date +%Y%m%d_%H%M%S).json
        echo "validation_file=output/rss_validation_$(date +%Y%m%d_%H%M%S).json" >> $GITHUB_OUTPUT
    
    - name: ğŸ” Check for RSS failures
      id: check_failures
      run: |
        # æ£€æŸ¥éªŒè¯ç»“æœä¸­æ˜¯å¦æœ‰å¤±è´¥çš„RSSæº
        if [ -f "${{ steps.validate.outputs.validation_file }}" ]; then
          FAILED_COUNT=$(python -c "
import json, sys
try:
    with open('${{ steps.validate.outputs.validation_file }}', 'r') as f:
        data = json.load(f)
        failed = [s for s in data.get('sources', []) if s.get('status') == 'failed']
        print(len(failed))
        if failed:
            print('FAILED_SOURCES<<EOF', file=sys.stderr)
            for s in failed:
                print(f\"- {s['name']}: {s.get('error', 'Unknown error')}\", file=sys.stderr)
            print('EOF', file=sys.stderr)
except Exception as e:
    print(0)
    print(f'Error: {e}', file=sys.stderr)
" 2>&1)
          
          echo "failed_count=$FAILED_COUNT" >> $GITHUB_OUTPUT
          
          if [ "$FAILED_COUNT" -gt 0 ]; then
            echo "has_failures=true" >> $GITHUB_OUTPUT
          else
            echo "has_failures=false" >> $GITHUB_OUTPUT
          fi
        else
          echo "failed_count=0" >> $GITHUB_OUTPUT
          echo "has_failures=false" >> $GITHUB_OUTPUT
        fi
    
    - name: ğŸ“§ Send failure notification email
      if: steps.check_failures.outputs.has_failures == 'true'
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.126.com
        server_port: 465
        secure: true
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: "âš ï¸ RSSæºå¼‚å¸¸é€šçŸ¥ - ${{ steps.check_failures.outputs.failed_count }}ä¸ªæºå¤±è´¥"
        to: liuyongshun2@126.com
        from: ${{ secrets.EMAIL_USERNAME }}
        body: |
          RSSæºéªŒè¯å‘ç°å¼‚å¸¸
          
          å¤±è´¥æ•°é‡: ${{ steps.check_failures.outputs.failed_count }}
          éªŒè¯æ—¶é—´: ${{ github.run_id }}
          
          è¯¦ç»†ä¿¡æ¯è¯·æŸ¥çœ‹GitHub Actionsè¿è¡Œæ—¥å¿—ï¼š
          ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          
          ---
          æ­¤é‚®ä»¶ç”±GitHub Actionsè‡ªåŠ¨å‘é€
    
    - name: ğŸ’¾ Commit validation results
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git add output/*.json
        git commit -m "chore: update RSS validation $(date +'%Y-%m-%d %H:%M:%S')" || echo "No changes to commit"
        git push || echo "Nothing to push"
    
    - name: ğŸ“Š Upload validation results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: rss-validation-${{ github.run_number }}
        path: |
          logs/
          output/
        retention-days: 7
    
    - name: ğŸ“ Create sync summary
      if: success()
      run: |
        echo "## ğŸ“° RSS æºéªŒè¯å®Œæˆ" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… éªŒè¯æ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
        if [ "${{ steps.check_failures.outputs.has_failures }}" == "true" ]; then
          echo "âš ï¸  å¤±è´¥æ•°é‡: ${{ steps.check_failures.outputs.failed_count }}" >> $GITHUB_STEP_SUMMARY
          echo "ğŸ“§ å·²å‘é€é‚®ä»¶é€šçŸ¥åˆ° liuyongshun2@126.com" >> $GITHUB_STEP_SUMMARY
        else
          echo "âœ… æ‰€æœ‰RSSæºæ­£å¸¸" >> $GITHUB_STEP_SUMMARY
        fi
        echo "ğŸ“Š æ•°æ®å·²ä¿å­˜åˆ° output/ ç›®å½•" >> $GITHUB_STEP_SUMMARY
        echo "ğŸ“‹ éªŒè¯æ—¥å¿—å·²ä¸Šä¼ åˆ° Artifacts" >> $GITHUB_STEP_SUMMARY