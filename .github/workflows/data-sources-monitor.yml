name: ðŸ” Monitor All Data Sources

on:
  schedule:
    # æ¯å¤©åŒ—äº¬æ—¶é—´21ç‚¹ (UTC 13:00) è¿è¡Œå…¨é¢æ£€æŸ¥
    - cron: '0 13 * * *'
  
  workflow_dispatch:  # æ”¯æŒæ‰‹åŠ¨è§¦å‘

jobs:
  monitor-all-sources:
    runs-on: ubuntu-latest
    
    steps:
    - name: ðŸ“¥ Checkout repository
      uses: actions/checkout@v4
    
    - name: ðŸ Set up Python 3.9
      uses: actions/setup-python@v5
      with:
        python-version: '3.9'
        cache: 'pip'
    
    - name: ðŸ“¦ Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: âš™ï¸ Create output directory
      run: |
        mkdir -p logs output/validation
    
    - name: ðŸ§ª Test all data sources
      id: test_sources
      env:
        DEEPSEEK_API_KEY: ${{ secrets.DEEPSEEK_API_KEY }}
      run: |
        echo "Testing all data sources..." > output/monitor_report.txt
        echo "======================================" >> output/monitor_report.txt
        echo "" >> output/monitor_report.txt
        
        # 1. æµ‹è¯•RSSæº
        echo "ðŸ“° Testing RSS Sources..." >> output/monitor_report.txt
        python test/validate_sources.py > output/rss_test.log 2>&1 || true
        RSS_FAILURES=$(grep -E "å¤±è´¥:|âŒ" output/rss_test.log | wc -l | tr -d ' ')
        echo "RSSå¤±è´¥æ•°: $RSS_FAILURES" >> output/monitor_report.txt
        echo "" >> output/monitor_report.txt
        
        # 2. æµ‹è¯•GitHub
        echo "ðŸ™ Testing GitHub Trending..." >> output/monitor_report.txt
        python -c "
import asyncio
import sys
sys.path.insert(0, '.')
from src.msgskill.tools.github_fetcher import fetch_github_trending

async def test():
    result = await fetch_github_trending(limit=5)
    if not result.success:
        print(f'GitHub Trendingå¤±è´¥: {result.error}')
        return 1
    print(f'GitHub Trendingæ­£å¸¸: {result.total_count}ä¸ªé¡¹ç›®')
    return 0

sys.exit(asyncio.run(test()))
        " >> output/monitor_report.txt 2>&1
        GITHUB_STATUS=$?
        
        # 3. æµ‹è¯•Hacker News
        echo "" >> output/monitor_report.txt
        echo "ðŸ“¡ Testing Hacker News..." >> output/monitor_report.txt
        python -c "
import asyncio
import sys
sys.path.insert(0, '.')
from src.msgskill.tools.news_scraper import fetch_ai_news

async def test():
    result = await fetch_ai_news(source='hackernews', limit=5)
    if not result.success:
        print(f'Hacker Newså¤±è´¥: {result.error}')
        return 1
    print(f'Hacker Newsæ­£å¸¸: {result.total_count}ä¸ªæ–°é—»')
    return 0

sys.exit(asyncio.run(test()))
        " >> output/monitor_report.txt 2>&1
        HN_STATUS=$?
        
        # 4. æµ‹è¯•arXivï¼ˆæµ‹è¯•ä¸€ä¸ªåˆ†ç±»å³å¯ï¼‰
        echo "" >> output/monitor_report.txt
        echo "ðŸ“š Testing arXiv..." >> output/monitor_report.txt
        python -c "
import asyncio
import sys
sys.path.insert(0, '.')
from src.msgskill.tools.arxiv_fetcher import fetch_arxiv_papers

async def test():
    result = await fetch_arxiv_papers(category='cs.AI', max_results=3)
    if 'error' in result and result['error']:
        print(f'arXivå¤±è´¥: {result[\"error\"]}')
        return 1
    count = result.get('count', 0)
    print(f'arXivæ­£å¸¸: {count}ç¯‡è®ºæ–‡')
    return 0

sys.exit(asyncio.run(test()))
        " >> output/monitor_report.txt 2>&1
        ARXIV_STATUS=$?
        
        # æ±‡æ€»ç»“æžœ
        echo "" >> output/monitor_report.txt
        echo "======================================" >> output/monitor_report.txt
        echo "ðŸ“Š Summary:" >> output/monitor_report.txt
        echo "- RSSæºå¤±è´¥æ•°: $RSS_FAILURES" >> output/monitor_report.txt
        echo "- GitHubçŠ¶æ€: $([ $GITHUB_STATUS -eq 0 ] && echo 'âœ… æ­£å¸¸' || echo 'âŒ å¼‚å¸¸')" >> output/monitor_report.txt
        echo "- Hacker NewsçŠ¶æ€: $([ $HN_STATUS -eq 0 ] && echo 'âœ… æ­£å¸¸' || echo 'âŒ å¼‚å¸¸')" >> output/monitor_report.txt
        echo "- arXivçŠ¶æ€: $([ $ARXIV_STATUS -eq 0 ] && echo 'âœ… æ­£å¸¸' || echo 'âŒ å¼‚å¸¸')" >> output/monitor_report.txt
        
        # åˆ¤æ–­æ˜¯å¦æœ‰å¤±è´¥
        TOTAL_FAILURES=$((RSS_FAILURES + GITHUB_STATUS + HN_STATUS + ARXIV_STATUS))
        
        if [ $TOTAL_FAILURES -gt 0 ]; then
          echo "has_failures=true" >> $GITHUB_OUTPUT
          echo "total_failures=$TOTAL_FAILURES" >> $GITHUB_OUTPUT
        else
          echo "has_failures=false" >> $GITHUB_OUTPUT
          echo "total_failures=0" >> $GITHUB_OUTPUT
        fi
        
        # è¾“å‡ºåˆ°æŽ§åˆ¶å°
        cat output/monitor_report.txt
      continue-on-error: true
    
    - name: ðŸ“§ Send failure notification
      if: steps.test_sources.outputs.has_failures == 'true'
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.126.com
        server_port: 465
        secure: true
        username: ${{ secrets.EMAIL_USERNAME }}
        password: ${{ secrets.EMAIL_PASSWORD }}
        subject: "âš ï¸ æ•°æ®æºç›‘æŽ§å‘Šè­¦ - å‘çŽ°å¼‚å¸¸"
        to: liuyongshun2@126.com
        from: ${{ secrets.EMAIL_USERNAME }}
        body: |
          æ•°æ®æºæ¯æ—¥ç›‘æŽ§å‘çŽ°å¼‚å¸¸
          
          æ£€æµ‹æ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')
          
          å¼‚å¸¸ç»Ÿè®¡: ${{ steps.test_sources.outputs.total_failures }}å¤„
          
          è¯¦ç»†æŠ¥å‘Šå·²ä¿å­˜ï¼Œè¯·æŸ¥çœ‹è¿è¡Œæ—¥å¿—ï¼š
          ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          
          ---
          å»ºè®®ï¼š
          1. æ£€æŸ¥å¤±è´¥çš„æ•°æ®æºè¿žæŽ¥
          2. æŸ¥çœ‹è¯¦ç»†æ—¥å¿—åˆ†æžå¤±è´¥åŽŸå› 
          3. å¿…è¦æ—¶æ›´æ–°é…ç½®æˆ–ç¦ç”¨å¤±è´¥æº
          
          æ­¤é‚®ä»¶ç”±GitHub Actionsè‡ªåŠ¨å‘é€
        attachments: output/monitor_report.txt
    
    - name: ðŸ’¾ Save monitoring report
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        cp output/monitor_report.txt output/monitor_latest.txt
        git add output/monitor_latest.txt
        git commit -m "chore: update monitoring report $(date +'%Y-%m-%d')" || echo "No changes"
        git push || echo "Nothing to push"
    
    - name: ðŸ“Š Upload monitoring results
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: monitoring-report-${{ github.run_number }}
        path: |
          output/
        retention-days: 30
    
    - name: ðŸ“ Create summary
      if: always()
      run: |
        echo "## ðŸ” æ•°æ®æºç›‘æŽ§æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "æ£€æµ‹æ—¶é—´: $(date +'%Y-%m-%d %H:%M:%S')" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ steps.test_sources.outputs.has_failures }}" == "true" ]; then
          echo "âš ï¸ **å‘çŽ°å¼‚å¸¸**: ${{ steps.test_sources.outputs.total_failures }}å¤„" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ“§ å·²å‘é€é‚®ä»¶é€šçŸ¥åˆ° liuyongshun2@126.com" >> $GITHUB_STEP_SUMMARY
        else
          echo "âœ… **æ‰€æœ‰æ•°æ®æºæ­£å¸¸**" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "è¯¦ç»†æŠ¥å‘Šå·²ä¿å­˜åˆ°ä»“åº“ output/monitor_latest.txt" >> $GITHUB_STEP_SUMMARY