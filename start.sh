#!/bin/bash

# MsgSkill ç»Ÿä¸€å¯åŠ¨è„šæœ¬
# åŒæ—¶å¯åŠ¨å®šæ—¶ä»»åŠ¡å’Œé¢„è§ˆæœåŠ¡

echo "================================================"
echo "ðŸš€ MsgSkill - AIä¿¡æ¯èšåˆä¸“å®¶"
echo "================================================"
echo ""

# æ£€æŸ¥ä¾èµ–
echo "æ£€æŸ¥ä¾èµ–..."
if ! python3 -c "import flask" 2>/dev/null; then
    echo "å®‰è£…ä¾èµ–..."
    pip3 install -r requirements.txt
fi

echo ""
echo "================================================"
echo "å¯åŠ¨æœåŠ¡"
echo "================================================"
echo ""

# å¯åŠ¨å®šæ—¶ä»»åŠ¡ï¼ˆå‰å°è¿è¡Œï¼Œæ˜¾ç¤ºæ‰§è¡Œè¿›åº¦ï¼‰
echo "â–¶ å¯åŠ¨å®šæ—¶ä»»åŠ¡è°ƒåº¦å™¨..."
echo "  è°ƒåº¦å™¨å°†ç«‹å³æ‰§è¡Œä¸€æ¬¡æ‰€æœ‰ä»»åŠ¡ï¼Œç„¶åŽæŒ‰è®¡åˆ’å®šæœŸæ‰§è¡Œ"
echo "  é¢„è§ˆæœåŠ¡å°†åœ¨ä»»åŠ¡æ‰§è¡Œå®ŒæˆåŽå¯åŠ¨"
echo ""
echo "================================================"
echo "æ‰§è¡Œä¸­ - è¯·ç­‰å¾…é¦–æ¬¡åŒæ­¥å®Œæˆ..."
echo "================================================"
echo ""

# å…ˆæ‰§è¡Œä¸€æ¬¡æ‰€æœ‰ä»»åŠ¡ï¼ˆå‰å°è¿è¡Œï¼Œæ˜¾ç¤ºè¿›åº¦ï¼‰
# python3 src/msgskill/multi_scheduler.py --once

echo ""
echo "================================================"
echo "âœ… é¦–æ¬¡åŒæ­¥å®Œæˆ"
echo "================================================"
echo ""

# å¯åŠ¨å®šæ—¶ä»»åŠ¡ï¼ˆåŽå°è¿è¡Œï¼Œæ—¥å¿—å†™å…¥æ–‡ä»¶ï¼‰
echo "â–¶ å¯åŠ¨åŽå°å®šæ—¶è°ƒåº¦å™¨..."
python3 src/msgskill/multi_scheduler.py > logs/scheduler.log 2>&1 &
SCHEDULER_PID=$!
echo "  âœ“ è°ƒåº¦å™¨PID: $SCHEDULER_PID"
echo "  âœ“ æ—¥å¿—æ–‡ä»¶: logs/scheduler.log"

# ç­‰å¾…ä¸€ä¸‹ç¡®ä¿è°ƒåº¦å™¨å¯åŠ¨
sleep 2

# å¯åŠ¨é¢„è§ˆæœåŠ¡ï¼ˆå‰å°è¿è¡Œï¼‰
echo ""
echo "â–¶ å¯åŠ¨æ•°æ®é¢„è§ˆæœåŠ¡..."
echo "  è®¿é—®åœ°å€: http://localhost:5001"
echo ""
echo "================================================"
echo "æŒ‰ Ctrl+C åœæ­¢æ‰€æœ‰æœåŠ¡"
echo "================================================"
echo ""

# æ•èŽ·é€€å‡ºä¿¡å·ï¼Œæ¸…ç†åŽå°è¿›ç¨‹
trap "echo ''; echo 'æ­£åœ¨åœæ­¢æœåŠ¡...'; kill $SCHEDULER_PID 2>/dev/null; exit" INT TERM

# å¯åŠ¨é¢„è§ˆæœåŠ¡ï¼ˆå‰å°ï¼‰
python3 src/msgskill/preview_server.py

# å¦‚æžœé¢„è§ˆæœåŠ¡é€€å‡ºï¼Œä¹Ÿåœæ­¢è°ƒåº¦å™¨
kill $SCHEDULER_PID 2>/dev/null
