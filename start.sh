#!/bin/bash

# MsgSkill ç»Ÿä¸€å¯åŠ¨è„šæœ¬
# åŒæ—¶å¯åŠ¨å®šæ—¶ä»»åŠ¡å’Œé¢„è§ˆæœåŠ¡

echo "================================================"
echo "ðŸš€ MsgSkill - AIä¿¡æ¯èšåˆä¸“å®¶"
echo "================================================"
echo ""

# æ£€æŸ¥ä¾èµ–
echo "æ£€æŸ¥ä¾èµ–..."
if ! python3 -c "import flask" 2>/dev/null; then
    echo "å®‰è£…ä¾èµ–..."
    pip3 install -r requirements.txt
fi

echo ""
echo "================================================"
echo "å¯åŠ¨æœåŠ¡"
echo "================================================"
echo ""

# å¯åŠ¨å®šæ—¶ä»»åŠ¡ï¼ˆå‰å°è¿è¡Œï¼Œæ˜¾ç¤ºæ‰§è¡Œè¿›åº¦ï¼‰
echo "â–¶ å¯åŠ¨å®šæ—¶ä»»åŠ¡è°ƒåº¦å™¨..."
echo "  è°ƒåº¦å™¨å°†ç«‹å³æ‰§è¡Œä¸€æ¬¡æ‰€æœ‰ä»»åŠ¡ï¼Œç„¶åŽæŒ‰è®¡åˆ’å®šæœŸæ‰§è¡Œ"
echo "  é¢„è§ˆæœåŠ¡å°†åœ¨ä»»åŠ¡æ‰§è¡Œå®ŒæˆåŽå¯åŠ¨"
echo ""
echo "================================================"
echo "æ‰§è¡Œä¸­ - è¯·ç­‰å¾…é¦–æ¬¡åŒæ­¥å®Œæˆ..."
echo "================================================"
echo ""

# å…ˆæ‰§è¡Œä¸€æ¬¡æ‰€æœ‰ä»»åŠ¡ï¼ˆå‰å°è¿è¡Œï¼Œæ˜¾ç¤ºè¿›åº¦ï¼‰
echo "æ‰§è¡Œé¦–æ¬¡åŒæ­¥..."
# python3 src/msgskill/multi_scheduler.py --once

echo ""
echo "================================================"
echo "âœ… é¦–æ¬¡åŒæ­¥å®Œæˆ"
echo "================================================"
echo ""

# å¯åŠ¨å®šæ—¶ä»»åŠ¡ï¼ˆåŽå°è¿è¡Œï¼Œæ—¥å¿—åŒæ—¶è¾“å‡ºåˆ°æŽ§åˆ¶å°å’Œæ–‡ä»¶ï¼‰
echo "â–¶ å¯åŠ¨åŽå°å®šæ—¶è°ƒåº¦å™¨..."
# ä½¿ç”¨ tee åŒæ—¶è¾“å‡ºåˆ°ç»ˆç«¯å’Œæ–‡ä»¶ï¼Œ-a è¡¨ç¤ºè¿½åŠ æ¨¡å¼
# æ³¨æ„ï¼šåŽå°è¿›ç¨‹çš„è¾“å‡ºä¼šåŒæ—¶æ˜¾ç¤ºåœ¨ç»ˆç«¯å’Œå†™å…¥æ–‡ä»¶
python3 src/msgskill/multi_scheduler.py 2>&1 | tee -a logs/scheduler.log &
SCHEDULER_PID=$!
echo "  âœ“ è°ƒåº¦å™¨PID: $SCHEDULER_PID"
echo "  âœ“ æ—¥å¿—åŒæ—¶è¾“å‡ºåˆ°æŽ§åˆ¶å°å’Œæ–‡ä»¶: logs/scheduler.log"

# ç­‰å¾…ä¸€ä¸‹ç¡®ä¿è°ƒåº¦å™¨å¯åŠ¨
sleep 2

# æ£€æŸ¥å¹¶æ€æŽ‰å ç”¨5001ç«¯å£çš„è¿›ç¨‹
echo "â–¶ æ£€æŸ¥ç«¯å£5001..."
PORT_PID=$(lsof -ti:5001 2>/dev/null)
if [ -n "$PORT_PID" ]; then
    echo "  âš  å‘çŽ°ç«¯å£5001è¢«å ç”¨ (PID: $PORT_PID)ï¼Œæ­£åœ¨ç»ˆæ­¢..."
    kill -9 $PORT_PID 2>/dev/null
    sleep 1
    echo "  âœ“ ç«¯å£5001å·²é‡Šæ”¾"
else
    echo "  âœ“ ç«¯å£5001å¯ç”¨"
fi

# å¯åŠ¨é¢„è§ˆæœåŠ¡ï¼ˆå‰å°è¿è¡Œï¼‰
echo ""
echo "â–¶ å¯åŠ¨æ•°æ®é¢„è§ˆæœåŠ¡..."
echo "  è®¿é—®åœ°å€: http://localhost:5001"
echo ""
echo "================================================"
echo "æŒ‰ Ctrl+C åœæ­¢æ‰€æœ‰æœåŠ¡"
echo "================================================"
echo ""

# æ•èŽ·é€€å‡ºä¿¡å·ï¼Œæ¸…ç†åŽå°è¿›ç¨‹
trap "echo ''; echo 'æ­£åœ¨åœæ­¢æœåŠ¡...'; kill $SCHEDULER_PID 2>/dev/null; exit" INT TERM

# å¯åŠ¨é¢„è§ˆæœåŠ¡ï¼ˆå‰å°ï¼‰
python3 src/msgskill/preview_server.py

# å¦‚æžœé¢„è§ˆæœåŠ¡é€€å‡ºï¼Œä¹Ÿåœæ­¢è°ƒåº¦å™¨
kill $SCHEDULER_PID 2>/dev/null
