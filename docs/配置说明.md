# MsgSkill 配置说明文档

**配置文件**: `config/sources.json`  
**最后更新**: 2026-02-09
**新增功能**: 翻译配置开关（所有数据源独立控制）

---

## 📋 配置文件结构

```json
{
  "sources": {
    "news": { ... },      // 新闻源配置
    "rss": { ... },       // RSS 源配置
    "github": { ... },    // GitHub 源配置
    "arxiv": { ... }      // arXiv 论文配置
  },
  "global_settings": {
    "maintenance": { ... },   // 维护配置
    "scheduler": { ... }      // 调度器配置
  },
  "llm": { ... }         // AI 模型配置
}
```

---

## 🔄 新增功能：翻译配置开关

### 功能概述
新增了**翻译配置开关功能**，允许独立控制每个数据源的翻译行为。用户可以根据内容类型和成本考虑，灵活配置是否启用AI翻译功能。

### 配置特性
- **独立控制**: 每个数据源都有独立的 `translation_enabled` 配置项
- **默认启用**: 为了保持向后兼容性，默认启用翻译功能
- **成本优化**: 支持按需禁用不必要的翻译，节省AI Token成本

### 适用的数据源类型
所有四大类数据源均支持翻译配置：
- **News 新闻源**: HackerNews等
- **RSS 订阅源**: 32个技术博客和新闻源
- **arXiv 论文源**: 13个学术分类
- **GitHub 项目源**: 每日热门项目

### 配置示例
**启用单个源翻译**（默认行为）:
```json
{
  "translation_enabled": true
}
```

**禁用单个源翻译**（节省Token）:
```json
{
  "translation_enabled": false
}
```

---

## 🔧 全局配置 (global_settings)

### 基础设置

```json
{
  "default_cache_ttl": 300,           // 默认缓存时间（秒）
  "default_fetch_limit": 10,          // 默认抓取数量
  "max_fetch_limit": 50,              // 最大抓取数量
  "request_timeout": 30,              // 请求超时时间（秒）
  "user_agent": "Mozilla/5.0 ..."    // HTTP 请求 User-Agent
}
```

### 维护配置 (maintenance)

```json
{
  "maintenance": {
    "log_retention_days": 7,          // 日志保留天数
    "cache_retention_days": 30,       // 缓存保留天数
    "auto_cleanup": {
      "enabled": true,                // 启用自动清理
      "log_cleanup_time": "03:00",    // 日志清理时间（每天）
      "cache_cleanup_time": "02:00",  // 缓存清理时间
      "cache_cleanup_day": "sunday"   // 缓存清理日期（每周）
    }
  }
}
```

**说明**:
- `log_retention_days`: 保留最近N天的日志文件
- `cache_retention_days`: 保留最近N天的缓存文件
- `auto_cleanup.enabled`: 启用后，调度器会自动执行清理任务

### 调度器配置 (scheduler)

```json
{
  "scheduler": {
    "enabled": true,                  // 全局开关
    "tasks": {
      "arxiv": {
        "enabled": true,              // arXiv 任务开关
        "time": "09:00",              // 执行时间
        "max_results": 20,            // 每个分类最多抓取论文数
        "translation_strategy": {
          "enabled": true,
          "selective_translation": true,  // 选择性翻译
          "min_authors": 2                // 最小作者数阈值
        }
      },
      "hackernews": {
        "enabled": true,
        "time": "10:00",
        "max_results": 50
      },
      "rss": {
        "enabled": true,
        "time": ["06:00", "08:00", ..., "22:00"],  // 多个时间点
        "max_results": 20
      },
      "github": {
        "enabled": true,
        "time": "14:00",
        "max_results": 100
      }
    }
  }
}
```

**说明**:
- `enabled`: 全局开关，关闭后所有任务都不执行
- `tasks.*.enabled`: 单个任务开关
- `tasks.*.time`: 执行时间（24小时制），支持字符串或数组
- `tasks.*.max_results`: 控制抓取数量

---

## 🤖 AI 模型配置 (llm)

```json
{
  "llm": {
    "enabled": true,                            // 启用 AI 功能
    "provider": "deepseek",                     // 提供商
    "api_key": "sk-xxxxxxxxxx",                 // API 密钥
    "api_url": "https://api.deepseek.com/v1/chat/completions",
    "model_name": "deepseek-chat",              // 模型名称
    "max_tokens": 1000,                         // 最大 token 数
    "temperature": 0.3                          // 温度参数
  }
}
```

**参数说明**:
- `enabled`: 启用后才会进行 AI 筛选和翻译
- `api_key`: DeepSeek API 密钥（获取地址：https://platform.deepseek.com/）
- `max_tokens`: 控制 AI 响应长度
- `temperature`: 控制 AI 输出随机性（0.0-1.0，越低越确定）

**Token 优化建议**:
- arXiv 选择性翻译可节省 76% token
- GitHub 白名单缓存可节省 70-85% token

---

## 📰 数据源配置

### 1. HackerNews 配置

**配置位置**: `sources.news.hackernews`

```json
{
  "enabled": true,
  "name": "Hacker News",
  "type": "api",
  "api_base_url": "https://hacker-news.firebaseio.com/v0",
  "story_types": ["top", "new", "best"],       // 新闻类型
  "ai_filter_enabled": true,                   // 启用 AI 筛选
  "translation_enabled": true,                 // 启用文章翻译（新增）
  "fetch_limit": {
    "default": 10,
    "max": 50
  }
}
```

**新增配置项**：
- `translation_enabled`: 控制是否启用文章翻译，默认启用 (`true`)
  - 设置为 `false` 可禁用翻译，节省 AI Token
  - 适用于大量英文内容，用户可阅读原文的场景

**story_types 说明**:
- `top`: 热门新闻
- `new`: 最新新闻
- `best`: 高分新闻

### 2. RSS 源配置

**配置位置**: `sources.rss.*`

**单个 RSS 源示例**:
```json
{
  "mit_tech_review": {
    "enabled": true,                          // 是否启用
    "name": "MIT Technology Review AI",       // 显示名称
    "url": "https://www.technologyreview.com/feed/",  // RSS URL
    "description": "MIT科技评论AI频道",        // 描述
    "category": "technology_news",            // 分类
    "tags": ["AI资讯", "技术博客"],            // 标签
    "ai_filter_enabled": true,                // 是否启用 AI 筛选
    "translation_enabled": true               // 启用文章翻译（新增）
  }
}
```

**新增配置项**：
- `translation_enabled`: 控制是否启用文章翻译，默认启用 (`true`)
  - 对于英文技术博客，可禁用翻译以节省成本
  - 对于中文内容，建议始终启用翻译（无额外成本）

**category 类别**:
- `technology_news`: 科技新闻
- `company_blog`: 公司博客
- `personal_blog`: 个人博客
- `newsletter`: 邮件通讯
- `tech_community`: 技术社区
- `ai_tools`: AI 工具
- `papers`: 论文
- `trends`: 趋势分析
- `engineering`: 工程实践

**tags 标签**:
- `AI资讯`: 通用 AI 新闻
- `AI工具`: AI 工具和产品
- `AI论文`: 学术论文
- `技术博客`: 技术深度内容
- `趋势分析`: 行业趋势

### 3. GitHub 配置

**配置位置**: `sources.github.trending_daily`

```json
{
  "enabled": true,
  "languages": ["python", "javascript", "typescript", "rust"],
  "topics": ["ai"],                            // 搜索关键词
  "trending_types": ["pushed", "created", "stars"],
  "star_limits": {
    "pushed": 500,                             // pushed 类型最小 star 数
    "created": 100,                            // created 类型最小 star 数
    "stars": 500                               // stars 类型最小 star 数
  },
  "ai_filter_enabled": true,                   // 启用 AI 筛选
  "translation_enabled": true,                 // 启用项目翻译（新增）
  "database_enabled": true                     // 启用 GitHub 数据库功能（新增）
}
```

**新增配置项**：
- `translation_enabled`: 控制是否启用项目描述翻译，默认启用 (`true`)
  - GitHub项目多为英文，翻译能提供更好的中文理解
  - 禁用后可节省翻译Token，适合熟悉英文的用户

- `database_enabled`: 启用GitHub数据库功能，默认启用 (`true`)
  - **智能去重**: 避免重复抓取和筛选已存在的项目
  - **持久化存储**: 项目数据保存到 `output/github/` 目录
  - **高效检索**: 快速访问历史筛选的AI项目
  - **白名单缓存**: 已筛选的AI项目缓存30天，大幅节省Token

**数据流优化**：
1. 先查询GitHub数据库检查项目是否已存在
2. 已存在的AI项目直接返回，跳过AI筛选
3. 新项目进行AI筛选，结果存入数据库
4. 超过30天的项目自动清理

**数据库文件说明**:
- `all_projects.json`: 存储所有抓取过的GitHub项目
- `ai_projects.json`: 存储通过AI筛选的AI相关项目  
- `ai_whitelist.json`: AI项目白名单，30天过期缓存

**trending_types 说明**:
- `pushed`: 最近7天有推送的项目
- `created`: 最近180天创建的项目
- `stars`: 最近180天创建的高 star 项目

**语言支持**:
- `python`
- `javascript`
- `typescript`
- `rust`

### 4. arXiv 论文配置

**配置位置**: `sources.arxiv.*`

**单个分类示例**:
```json
{
  "cs_ai": {
    "enabled": true,                          // 是否启用
    "name": "Artificial Intelligence",        // 显示名称
    "category": "cs.AI",                      // arXiv 分类代码
    "description": "人工智能领域论文",         // 描述
    "tags": ["AI论文"],                       // 标签
    "translation_enabled": true               // 启用论文翻译（新增）
  }
}
```

**新增配置项**：
- `translation_enabled`: 控制是否启用论文摘要翻译，默认启用 (`true`)
  - arXiv论文多为英文技术内容，翻译有助于理解
  - 启用选择性翻译策略时，进一步优化Token使用

**已支持的分类**:
- `cs.AI` - 人工智能
- `cs.LG` - 机器学习
- `cs.CL` - 自然语言处理
- `cs.CV` - 计算机视觉
- `cs.NE` - 神经网络与进化计算
- `cs.RO` - 机器人
- `stat.ML` - 统计机器学习
- `cs.IR` - 信息检索
- `cs.SE` - 软件工程
- `cs.MA` - 多智能体系统
- `cs.HC` - 人机交互
- `cs.DC` - 分布式计算
- `eess.AS` - 音频与语音处理

---

## 🎯 配置示例

### 示例1：添加新的 RSS 源

在 `sources.rss` 中添加：

```json
{
  "new_ai_blog": {
    "enabled": true,
    "name": "新AI博客",
    "url": "https://example.com/feed.xml",
    "description": "某个AI技术博客",
    "category": "tech_community",
    "tags": ["AI资讯", "技术博客"],
    "ai_filter_enabled": true
  }
}
```

### 示例2：禁用某个数据源

将 `enabled` 设为 `false`：

```json
{
  "google_ai": {
    "enabled": false,     // 禁用此数据源
    "name": "Google AI Blog",
    ...
  }
}
```

### 示例3：调整抓取数量

修改 `scheduler.tasks` 中的 `max_results`：

```json
{
  "scheduler": {
    "tasks": {
      "arxiv": {
        "max_results": 30    // 从 20 调整到 30
      }
    }
  }
}
```

### 示例4：修改执行时间

```json
{
  "scheduler": {
    "tasks": {
      "github": {
        "time": "15:00"      // 从 14:00 改为 15:00
      }
    }
  }
}
```

### 示例5：添加新的 arXiv 分类

在 `sources.arxiv` 中添加：

```json
{
  "cs_sy": {
    "enabled": true,
    "name": "Systems and Control",
    "category": "cs.SY",
    "description": "系统与控制领域论文",
    "tags": ["AI论文"]
  }
}
```

---

## 🔍 配置验证

### 验证 JSON 格式

```bash
# 检查 JSON 格式是否正确
python3 -c "import json; json.load(open('config/sources.json'))"

# 如果没有输出，说明格式正确
# 如果有错误，会显示具体的错误位置
```

### 验证配置加载

```bash
# 测试配置是否能正确加载
python3 -c "
from src.msgskill.config import get_config
config = get_config()
print('✅ 配置加载成功')
print(f'调度器启用: {config.global_settings.scheduler.get(\"enabled\")}')
"
```

### 验证翻译配置（新增）

```bash
# 测试翻译配置是否正确加载
python3 -c "
from src.msgskill.config import get_config
config = get_config()

# 测试各个数据源的翻译配置
news_config = config.get_news_source('hackernews')
rss_config = config.get_rss_source('mit_tech_review')
arxiv_config = config.get_arxiv_categories().get('cs_ai')
github_config = config.get_github_source('trending_daily')

print('📊 翻译配置验证结果:')
print(f'  HackerNews翻译: {news_config.translation_enabled if news_config else \"未找到\"}')
print(f'  RSS翻译: {rss_config.translation_enabled if rss_config else \"未找到\"}')
print(f'  arXiv翻译: {arxiv_config.translation_enabled if arxiv_config else \"未找到\"}')
print(f'  GitHub翻译: {github_config.translation_enabled if github_config else \"未找到\"}')

# 通用方法测试
print('🎯 通用配置获取测试:')
for source_key in ['news.hackernews', 'rss.mit_tech_review', 'arxiv.cs_ai', 'github.trending_daily']:
    source_config = config.get_source_config(source_key)
    if source_config:
        print(f'  {source_key}: 翻译{"启用" if getattr(source_config, \"translation_enabled\", False) else "禁用"}')
    else:
        print(f'  {source_key}: 配置获取失败')
"
```

**测试要点**:
- 验证所有数据源配置都能正确读取翻译设置
- 测试通用配置获取接口 `get_source_config()`
- 确认默认启用翻译功能正常工作

---

## 📊 配置最佳实践

### 1. Token 优化配置

**arXiv 论文**:
```json
{
  "arxiv": {
    "max_results": 20,                        // 从 50 减少到 20
    "translation_strategy": {
      "selective_translation": true,          // 只翻译多作者论文
      "min_authors": 2
    }
  }
}
```

**效果**: 节省 76% token

### 2. 数据源优先级

**高频更新**（每2小时）:
- RSS 源: `06:00-22:00` 每2小时

**中频更新**（每天1次）:
- arXiv: `09:00`
- HackerNews: `10:00`
- GitHub: `14:00`

### 3. 翻译配置优化（新增）

**智能启用翻译** - 节省 Token 成本：
```json
{
  "translation_enabled": true,    // 默认启用翻译
  "根据内容类型调整翻译策略": {
    "arXiv论文": "建议始终启用（技术内容需要翻译）",
    "英文技术博客": "可根据需要禁用（熟悉英文的用户）",
    "中文内容": "建议禁用（无翻译需求）",
    "GitHub项目": "建议启用（项目描述翻译有助理解）"
  }
}
```

**翻译策略建议**：
- **高优先级翻译**：arXiv论文摘要（技术内容理解重要）
- **中等优先级**：GitHub项目描述（技术信息重要）
- **可选翻译**：英文博客文章（可根据用户英文水平调整）
- **禁用翻译**：中文内容（无翻译需求）

### 4. AI 筛选策略

**全部启用 AI 筛选** - 确保内容相关性：
```json
{
  "ai_filter_enabled": true    // 所有数据源都应启用
}
```

**禁用 AI 筛选** - 节省 token（不推荐）：
```json
{
  "ai_filter_enabled": false   // 所有内容都会保存
}
```

### 4. 缓存配置

**短期缓存** - API 结果：
```json
{
  "cache_ttl": 300              // 5 分钟
}
```

**长期缓存** - GitHub 白名单：
- 自动缓存 30 天
- 无需手动配置

---

## 🚀 扩容指南

### 添加新的 RSS 源（最简单）

**步骤**:
1. 在 `sources.rss` 中添加配置
2. 无需编写代码
3. 重启服务生效

**示例**:
```json
{
  "new_source": {
    "enabled": true,
    "name": "新数据源",
    "url": "https://example.com/feed.xml",
    "description": "描述",
    "category": "news",
    "tags": ["AI资讯"],
    "ai_filter_enabled": true
  }
}
```

### 添加新的 arXiv 分类

**步骤**:
1. 在 `sources.arxiv` 中添加配置
2. 使用标准的 arXiv 分类代码
3. 重启服务生效

**示例**:
```json
{
  "cs_sy": {
    "enabled": true,
    "name": "Systems and Control",
    "category": "cs.SY",
    "description": "系统与控制领域论文",
    "tags": ["AI论文"]
  }
}
```

### 调整数据源优先级

通过修改 `scheduler.tasks.*.time` 调整执行顺序：

```json
{
  "arxiv": { "time": "09:00" },      // 第一优先级
  "hackernews": { "time": "10:00" }, // 第二优先级
  "github": { "time": "14:00" }      // 第三优先级
}
```

---

## ⚙️ 高级配置

### Token 优化配置

#### arXiv 选择性翻译

```json
{
  "arxiv": {
    "translation_strategy": {
      "selective_translation": true,
      "min_authors": 2,              // 只翻译作者数 >= 2 的论文
      "note": "节省约 76% 的翻译 token"
    }
  }
}
```

**效果**:
- 优化前: ~520,000 tokens/天
- 优化后: ~124,800 tokens/天
- **节省: 76%**

#### GitHub 白名单缓存

GitHub 白名单缓存**自动启用**，无需配置。

**原理**:
- 通过 AI 筛选的项目缓存 30 天
- 后续查询直接从白名单读取
- 只对新项目进行 AI 筛选

**效果**:
- 第 1 次: ~25,500 tokens
- 第 2 次: ~6,000 tokens (80% 命中白名单)
- **节省: 76%**

### 数据抓取控制

#### max_results 参数说明

| 数据源 | max_results 含义 | AI筛选 | 输出策略 |
|--------|-----------------|--------|---------|
| **arXiv** | 每个分类最多抓取论文数 | ❌ 无 | 全部保存 |
| **HackerNews** | 原始数据抓取上限 | ✅ 有 | AI筛选后全部保存 |
| **RSS** | 每个源最多抓取条目数 | ✅ 有 | AI筛选后全部保存 |
| **GitHub** | 每种查询类型抓取上限 | ✅ 有 | AI筛选后全部保存 |

**重要原则**: 避免浪费 AI Token
- `max_results` 只控制原始数据量
- AI 筛选后的**所有结果**都会保存
- 不会为 AI 筛选付费后却丢弃结果

### 时间配置格式

**单个时间点**:
```json
{
  "time": "09:00"
}
```

**多个时间点**:
```json
{
  "time": ["06:00", "08:00", "10:00"]
}
```

**时间格式**: `HH:MM`（24小时制）

---

## 🔒 安全配置

### API 密钥管理

**⚠️ 重要**:
1. 不要将包含真实 API 密钥的配置文件提交到公开仓库
2. 使用 `.gitignore` 保护配置文件
3. 定期更换 API 密钥

**生成安全的配置模板**:
```bash
python3 scripts/create_config_template.py
```

这会生成 `config/sources.json.example`（API 密钥已掩码）

### 访问控制

**预览服务** 默认绑定到 `localhost:5001`，仅本地访问。

如需外网访问，需修改 `src/msgskill/preview_server.py`：
```python
app.run(host='0.0.0.0', port=5001)  # 允许外网访问（慎用）
```

---

## 📖 相关文档

- [部署指南](./DEPLOYMENT.md) - 完整的部署说明
- [维护管理](./DEPLOYMENT.md#定期维护) - 日志和缓存清理
- [数据源扩展](./接入方案与扩容指南.md) - 添加新数据源
- [README](../README.md) - 项目概述

---

**版本**: 3.2.0  
**最后更新**: 2026-02-09
**更新内容**:
- 新增翻译配置开关功能，支持独立控制每个数据源的翻译行为
- 为所有数据源类型（news、rss、arxiv、github）添加 `translation_enabled` 配置项
- 默认启用翻译功能，支持按需禁用以节省 AI Token